<!DOCTYPE html>
<html lang="en">
  <head>
    <title>World</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
      * {
        font-size: 10px;
      }
      #info {
        color: #fff;
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        display:block;
      }
      #info a {
        color: #046;
        font-weight: bold;
      }
      .side {
        width: 15rem;
        background-color: rgba(255, 255, 255, 0.5);
        height: auto; /*96vh;*/
        padding: 1rem 0.5rem;
        margin: 0;
      }
      .side-left {
        float: left;
        position: absolute;
        top: 7vh;
        left: 0;
      }
      .side-right {
        float: right;
        position: absolute;
        top: 0;
        right: 0;
      }
      canvas {
        width: 100vw;
        height: 100vh;
        padding: 0;
        margin: 0;
      }
      .hide { display: none; }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./res/css/epoch.min.css">
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script src="./js/three.js"></script>
    <script src="./js/controls/OrbitControls.js"></script>
    <script src="./js/objects/Reflector.js"></script>
    <script src="./js/loaders/MTLLoader.js"></script>
    <script src="./js/loaders/OBJLoader.js"></script>
    <script src="./js/WebGL.js"></script>
    <script src="./js/stats.js"></script>

    <!--
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="./js/epoch.min.js"></script>
    -->

    <script>
      if (WEBGL.isWebGLAvailable() === false) {
        document.body.appendChild(WEBGL.getWebGLErrorMessage());
      }

      var scene, camera, renderer, exporter, mesh;
      var sqSize = 100
      var globalObjects = []
      var noClickObjects = ['Ground', 'Grid', 'FadeoutMrr', 'GndMirror', 'GndMrr']
      var posMap = []
      var posX0 = -4
      var posZ0 = -4
      var cPosX = -4
      var cPosZ = -4
      var maxX = 12
      var maxZ = 6
      var stepX = 1
      var stepZ = 2
      var count = 0

      var raycaster = new THREE.Raycaster();
      var mouse = new THREE.Vector2();

      var modelsMap = {
        '1stbuilding': { scale: 15, oX: 20, oZ: 20 },
        '2squerbuild': { scale: 15, oX: 65, oZ: 50 },
        '3base': { scale: 15, oX: 45, oZ: 45 },
        'bmw': { scale: 15, oX: 50, oZ: 75 },
        'buildings1': { scale: 15, oX: 55, oZ: 75 },
        'lastnode': { scale: 15, oX: 50, oZ: 50 },
        'merscobj': { scale: 15, oX: 40, oZ: 50 },
        'moderntower': { scale: 15, oX: 80, oZ: 50 },
        'SciFi_3': { scale: 15, oX: 15, oZ: 90 },
        'scifitower': { scale: 15, oX: 50, oZ: 80 },
        'simlebuilding': { scale: 15, oX: 80, oZ: 20 },
        'tallbuilding': { scale: 15, oX: 20, oZ: 20 }
      }

      $(function() {
        Object.getOwnPropertyNames(modelsMap).forEach(function(model) {
          $('#typeSelect').append('<option value="' + model + '">' + model + '</option>')
        })

        $('#addBtn').click(function() {
          var mdl = $('#typeSelect').val()
          if (cPosX <= maxX) {
            cPosX += count === 0? 0 : stepX
          } else {
            cPosX = posX0
            cPosZ += stepZ
          }
          var sqOffset = { x: cPosX, z: cPosZ }
          addModel(scene, mdl, sqOffset)
          count++
        })
      })

      var stats = new Stats()
      stats.showPanel(0)
      document.body.appendChild(stats.dom)

      function createObject(scene, objName, params, callback) {
        var loader = new THREE.MTLLoader()

        var objPath = './res/obj/'
        loader.load(
          objPath + objName + '.mtl',
          function (materials) {
            materials.preload();
            new THREE.OBJLoader()
              .setMaterials(materials).load(objPath + objName + '.obj', function (object) {
                callback(object, params)
              },
              function (xhr) {
                // do nothing
              },
              function (err) {
                console.error('An error happened while loading MTL object.', err);
              }
            )
          }
        )
      }

      function onDocumentMouseDown(event) {
        // event.preventDefault()
        if (event.button === 0) {
          mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1
          mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1
          raycaster.setFromCamera(mouse, camera)

          var intersects = raycaster.intersectObjects(scene.children, true)
          if (intersects.length >= 1) {
            if (noClickObjects.indexOf(intersects[0].object.name) === -1) {
              console.log('Clicked object type: ' + intersects[0].object.geometry.name, intersects[0])
              $('.info-panel').removeClass('hide')
              $('.info-panel .obj-dist').text(intersects[0].distance)
              $('.info-panel .obj-type').text(intersects[0].object.parent.userData.type)
              $('.info-panel .obj-uuid').text(intersects[0].object.uuid)
            } else {
              $('.info-panel').addClass('hide')
            }
          }
        }
      }
      document.addEventListener('mousedown', onDocumentMouseDown, false)

      function rnd(min, max) {
        return Math.floor(Math.random() * max) + min
      }

      function setupWorld() {
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
        camera.position.set(1000, 1000, 1000);
        camera.translateX(500)
        camera.translateZ(1000)

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.Fog(0x000000, 1000, 4000);

        // ground
        var ground = new THREE.Mesh(new THREE.PlaneBufferGeometry(2000, 2000), new THREE.MeshPhongMaterial({ color: 0x333333, depthWrite: true }));
        ground.name = 'Ground'
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = false;
        ground.opacity = 0.8
        ground.translateX(500)
        ground.translateY(-500)
        scene.add(ground);

        var geometry = new THREE.PlaneBufferGeometry(2000, 2000);
        geometry.name = 'GndMirror'
        var groundMirror = new THREE.Reflector(geometry, {
          clipBias: 0.8,
          textureWidth: window.innerWidth * window.devicePixelRatio,
          textureHeight: window.innerHeight * window.devicePixelRatio,
          color: 0x70857d,
          recursion: 1
        });
        groundMirror.name = 'GndMrr'
        groundMirror.position.y = 0.5;
        groundMirror.rotateX(-Math.PI / 2);
        groundMirror.translateX(500)
        groundMirror.translateY(-500)
        scene.add(groundMirror);

        var fadeout = new THREE.Mesh(new THREE.PlaneBufferGeometry(2000, 2000), new THREE.MeshLambertMaterial({ color: 0x000802, opacity : 0.8 , transparent: true }))
        fadeout.name = 'FadeoutMrr'
        fadeout.position.y = 0.75
        fadeout.rotateX(-Math.PI / 2)
        fadeout.translateX(500)
        fadeout.translateY(-500)
        scene.add(fadeout)

        var grid = new THREE.GridHelper(2000, 20, 0x08cc4c, 0x08cc4c);
        grid.name = 'Grid'
        grid.material.opacity = 1;
        grid.material.transparent = true;
        grid.translateX(500)
        grid.translateZ(500)
        scene.add(grid);

        // hemiLight
        var hemiLight = new THREE.HemisphereLight(0xffffff, 0xaaaaaa);
        hemiLight.position.set(0, 1000, 0);
        scene.add(hemiLight);
      }

      function addDirLight(scene, params) {
        var dirLight = new THREE.DirectionalLight(params.color, params.intensity);
        dirLight.position.set(params.coords.x, params.coords.y, params.coords.z);
        dirLight.castShadow = false;
        //dirLight.shadow.camera.top = 180;
        //dirLight.shadow.camera.bottom = -100;
        //dirLight.shadow.camera.left = -120;
        //dirLight.shadow.camera.right = 120;
        scene.add(dirLight);
      }

      function addModel(scene, model, sqOffset) {
        createObject(scene, model, sqOffset, function(obj, sqOffset) {
          obj.scale.set(modelsMap[model].scale, modelsMap[model].scale, modelsMap[model].scale)
          var oX = 0
          var oZ = 0
          if (sqOffset && typeof sqOffset === 'object') {
            oX = sqSize * sqOffset.x
            oZ = sqSize * sqOffset.z
          }
          obj.position.x = oX + modelsMap[model].oX
          obj.position.z = oZ + modelsMap[model].oZ
          obj.userData.type = model
          scene.add(obj);
        })
      }

      function init() {
        setupWorld()

        /*
        var max = rnd(3, 7)
        var sqOffset = {x: 0, y: 0}
        console.log('Max', max)

        for (var i = 0; i < max + 6; i++) {
          var coord = {x: rnd(-4, 16), z: rnd(-4, 16)}
          if (posMap.find(function(x){ return x.x == coord.x && x.z == coord.z })) {
            coord = {x: rnd(-4, 16), z: rnd(-4, 16)}
          }
          posMap.push(coord)
        }

        for (var i = 0; i < max; i++) {
          sqOffset = posMap[i]
        }
        */

        addDirLight(scene, {
          color: 0xffffff,
          intensity: 3,
          coords: { x: -200, y: 500, z: 200 }
        })
        addDirLight(scene, {
          color: 0xffffff,
          intensity: 3,
          coords: { x: 800, y: 500, z: 600 }
        })
        addDirLight(scene, {
          color: 0xffffff,
          intensity: 2,
          coords: { x: -450, y: 100, z: -4500 }
        })

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = false;
        document.body.appendChild(renderer.domElement);

        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(100, 100, 100);
        controls.maxPolarAngle = Math.PI / 2
        controls.update();

        window.addEventListener('resize', onWindowResize, false);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      var prev = 0

      function animate() {
        stats.begin()
        stats.end()
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }

      init();
      animate();

    </script>

    <div class="holder side side-left ctrl-panel">
      <div class="container">
        <h5>Add new object</h5>
        <form>
          <div class="form-group">
            <label for="typeSelect">Model type</label>
            <select class="form-control" id="typeSelect">
            </select>
          </div>
          <button id="addBtn" type="button" class="btn btn-primary">Add</button>
        </form>
      </div>
    </div>

    <div class="holder side side-right info-panel hide">
      <div class="container">
        <dl class="card-text">
          <dt>Type</dt>
          <dd class="obj-type">?</dd>
          <dt>UUID</dt>
          <dd class="obj-uuid">?</dd>
          <dt>Distance</dt>
          <dd class="obj-dist">?</dd>
        </dl>
        <div id="areaChart" class="epoch category10" style="height: 2rem;"></div>
      </div>
    </div>

  </body>
</html>
